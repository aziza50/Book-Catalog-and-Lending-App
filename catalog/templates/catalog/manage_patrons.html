{% extends "catalog/base.html" %}
{% block content %}
{% load static %}
<h1>All Patrons</h1>
    <hr class="mt-0 line-strip" >

<input type="text" id="patron-search" placeholder="Search patrons by name..." autocomplete="off" style="margin-bottom:1em;">
<ul id="patron-results"></ul>

    <table class="table table-hover align-middle">
        <thead>
        <tr>
            <th class="pe-4">Username</th>
            <th class="pe-4">Email</th>
            <th class="pe-4">Promote</th>
        </tr>
        </thead>
        <tbody id="patrons-table-body">
        {% for patron in patrons %}
            <tr>
                <td>{{ patron.username }}</td>
                <td>{{ patron.email }}</td>
                <td>
                    <form method="post" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ patron.id }}">
                        <button class = "btn btn-custom text-white" type="submit">Promote to Librarian</button>
                    </form>
                </td>
            </tr>
            {% empty %}
      <tr>
        <td colspan="3">No patrons found.</td>
      </tr>
    {% endfor %}
    <script>
      document.getElementById('patron-search').addEventListener('input', function() {
          const query = this.value;
          if (query.length < 2) {
              document.getElementById('patron-results').innerHTML = '';
              return;
          }
          fetch(`/catalog/patron_search/?q=${encodeURIComponent(query)}`)
              .then(response => response.json())
              .then(data => {
                  const results = data.results;
                  let html = '';
                  results.forEach(function(user) {
                      html += `
                        <li>
                          ${user.first_name} ${user.last_name} (${user.username}) - ${user.email}
                          <form method="post" style="display:inline;" action="/catalog/manage_patrons/">
                            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                            <input type="hidden" name="user_id" value="${user.id}">
                            <button type="submit">Promote</button>
                          </form>
                        </li>`;
                  });
                  document.getElementById('patron-results').innerHTML = html;
              });
      });
      </script>
  </tbody>
</table>


{% endblock content %}